<#include "/comm/head.html">
<body>
<style>
    .el-header, .el-footer{background-color: #e4e7ed;color: #333;text-align: center;line-height: 60px;}.el-header{background-color: #e4e7ed;color: #333;line-height: 60px;}/*.el-aside{background-color: #545c64;color: #333;text-align: left;line-height: 200px;}*/.el-aside{background-color: #2f4050;color: #333;}.el-main{background-color: #E9EEF3;color: #333;text-align: center;line-height: 160px;padding: 0px;overflow: visible !important;}.el-tabs--border-card>.el-tabs__content{height: 100%;padding: 0px;}.el-tabs__nav{height: 38px;}.el-tabs__item{top: -60px;}html, body, #app{height: 100%;margin: 0px;padding: 0px;display: flex;flex: 1;overflow: hidden;}.el-menu{border-right: solid 1px #293846;list-style: none;position: relative;margin: 0;padding-left: 0;}.row-canvas{position: relative;}/*.time-selecr{position: absolute;right: 20px;top: 20px;z-index: 99999;}*/.counts-liner{width: 100%;height: 50px;background: #393D49;box-sizing: border-box;padding: 0 20px;}.echarts-title{color: #fff;line-height: 50px;float: left;}.row-canvas{float: right;margin-top: 6px;width: 370px;height: 38px;}.row-canvas .layui-form-label{color: #fff ;width: 90px;}.four-echarts .contStyle{float: left;}.time-selecr{width: 300px;position: absolute;right: 10px;}.contStyle p{text-align: center;line-height: 400px;}.time-selecr .layui-input-inline{float: right;}.layui-inline.time-selecr{position: absolute;width: 310px;right: 10px;}.clearfix: after{content: "";display: table;clear: both;}
    .wrapper-row .grid-demo{box-sizing: border-box;padding: 14px 10px;}
    .tit-list{height: 30px;line-height: 30px;text-align: left;margin: 10px 20px;}
    .btn-data {display: block;
        float: right;
        height: 50px;
        line-height: 50px;
        cursor: pointer;
        color: #fff;}


    .el-tabs--border-card.is_active > .el-tabs__header .el-tabs__item {
        color: #409EFF;
        background-color: #fff;
        border-right-color: #dcdfe6;
        border-left-color: #dcdfe6;
    }

    .item {
        margin-top: 0px;
        margin-right: 40px;
    }
    .el-badge__content.is-fixed {
        position: absolute;
        top: 10px;
        right: 15px;
        -webkit-transform: translateY(-50%) translateX(100%);
        transform: translateY(-50%) translateX(100%);
    }

</style>
<div id="app">
    <el-container>
        <el-aside width="200px">
            <div style="position: relative;height: 150px;background: url(/rbac/lib/header-profile.png) no-repeat;">
                <div id="headPicDivId" style="text-align:center;padding-top: 30px" >
                    <img alt="image" :src="headPic"
                         style="border-radius: 10%; border: 1px solid rgb(147, 154, 160); width: 60px;height: 60px;">
                </div>
                <div id="nameDivId" style="text-align: center;color: #fff;" v-text="name"></div>
            </div>
            <div id="menuDivId" style="display: none">
                ${menuStr}
            </div>

        </el-aside>

        <el-container>
            <el-header style="text-align: right; font-size: 12px">

                <el-button v-if="userType != 1 && isShowTransfer != 0" type="text" style="font-size: 16px;" @click="openTag(3)">待受理需求：<span style="color:red;font-size: 18px;" v-text="transferNum"></span></el-button>

                <el-button v-if="userType != 1 && isShowCheck != 0" type="text" style="font-size: 16px;" @click="openTag(1)">待审核需求：<span style="color:red;font-size: 18px;" v-text="checkNum"></span></el-button>

                <el-button v-if="userType != 1 && isShowDeal != 0" type="text" style="font-size: 16px;" @click="openTag(2)">待处理需求：<span style="color:red;font-size: 18px;" v-text="dealNum"></span></el-button>

                <el-button type="text" @click="updatePwd()" style="font-size: 16px;">修改密码</el-button>
                <el-button type="text" @click="logout()" style="font-size: 16px;">退出登录</el-button>

            </el-header>
            <el-main>
                <el-tabs   :style="'height:'+ tabHeight+'px;'"  v-bind:class="{is_active: isActive}" v-model="activityTab" type="border-card" closable @tab-remove="removeTab">
                    <el-tab-pane label="首页" closable="false">
                        <#include "/comm/lineEchart.html">
                    </el-tab-pane>
                    <el-tab-pane style="height: 100%;" v-for="(item, index) in editableTabs"  :key="item.id"  :name="item.id">
                        <span slot="label"><i class="fa fa-list-ul"></i> {{item.title}}</span>
                        <iframe :id="item.id" :src="item.url"  frameborder="0" scrolling="no" marginwidth="0px" marginheight="0px"></iframe>
                    </el-tab-pane>
                </el-tabs>
            </el-main>
        </el-container>
    </el-container>
    <el-dialog  :close-on-click-modal="false" :close-on-press-escape="false" custom-class="dialogCustom0" @close="closeDialog(0)" :title="dialog[0].title" :visible.sync="dialog[0].visible" :width="dialog[0].width+20"><iframe :width="dialog[0].width" :height="dialog[0].height" id="dialog0" :src="dialogUrl(0)"  frameborder="0" scrolling="no" marginwidth="0px" marginheight="0px"></iframe></el-dialog>
    <el-dialog  :close-on-click-modal="false" :close-on-press-escape="false" custom-class="dialogCustom1" @close="closeDialog(1)" :title="dialog[1].title" :visible.sync="dialog[1].visible" :width="dialog[1].width+20"><iframe :width="dialog[1].width" :height="dialog[1].height" id="dialog1" :src="dialogUrl(1)"  frameborder="0" scrolling="no" marginwidth="0px" marginheight="0px"></iframe></el-dialog>
    <el-dialog  :close-on-click-modal="false" :close-on-press-escape="false" custom-class="dialogCustom2" @close="closeDialog(2)" :title="dialog[2].title" :visible.sync="dialog[2].visible" :width="dialog[2].width+20"><iframe :width="dialog[2].width" :height="dialog[2].height" id="dialog2" :src="dialogUrl(2)"  frameborder="0" scrolling="no" marginwidth="0px" marginheight="0px"></iframe></el-dialog>
    <el-dialog  :close-on-click-modal="false" :close-on-press-escape="false" custom-class="dialogCustom3" @close="closeDialog(3)" :title="dialog[3].title" :visible.sync="dialog[3].visible" :width="dialog[3].width+20"><iframe :width="dialog[3].width" :height="dialog[3].height" id="dialog3" :src="dialogUrl(3)"  frameborder="0" scrolling="no" marginwidth="0px" marginheight="0px"></iframe></el-dialog>
    <el-dialog  :close-on-click-modal="false" :close-on-press-escape="false" custom-class="dialogCustom4" @close="closeDialog(4)" :title="dialog[4].title" :visible.sync="dialog[4].visible" :width="dialog[4].width+20"><iframe :width="dialog[4].width" :height="dialog[4].height" id="dialog4" :src="dialogUrl(4)"  frameborder="0" scrolling="no" marginwidth="0px" marginheight="0px"></iframe></el-dialog>
    <iframe :src="exportUrl" style="display: none;" ></iframe>
</div>

<#include "/comm/js.html">
<script src="${base}/lib/ztree/js/jquery-1.4.4.min.js"></script>
<script type="text/javascript">
    //console.log(localStorage.getItem("headPic"));
    var vue = new Vue({
        el: '#app',
        data:{
            userType:1,
            checkNum:0,
            dealNum:0,
            transferNum:0,
            isShowCheck:1,
            isShowDeal:1,
            isShowTransfer:1,
            name: localStorage.getItem("name"),
            headPic: localStorage.getItem("headPic") != null && localStorage.getItem("headPic") != '' ? localStorage.getItem("headPic") : '${base}/lib/profile_small.jpg',
            dialog:[
                { title:'',visible:false,url:'',width:600,height:500 },
                { title:'',visible:false,url:'',width:600,height:500  },
                { title:'',visible:false,url:'',width:600,height:500  },
                { title:'',visible:false,url:'',width:600,height:500  },
                { title:'',visible:false,url:'',width:600,height:500  }
            ],
            exportUrl:'',
            menu: ${menu},
            editableTabs:[],
            activityTab:'',
            isActive:false
        },
        computed:{
            mainHeight:function(){
                return document.body.clientHeight-50;
            },
            tabHeight:function(){
                sessionStorage.setItem("sheight",document.body.clientHeight-130);
                return document.body.clientHeight-90;
            },
            tabWidth:function(){
                return document.body.clientWidth-230;
            }
        },
        // mounted:function(){
        //     this.mainHeight = document.body.clientHeight-60;
        //     console.log(this.mainHeight);
        // },
        methods: {
            export:function(url){
                this.exportUrl = url;
            },
            dialogShow:function(index,{title,url,width,height}){
                this.dialog[index].url=url;
                this.dialog[index].title = title;
                this.dialog[index].visible = true;
                this.dialog[index].height = height;
                this.dialog[index].width = width-20;
                $(".dialogCustom"+index).css("width",width+"px");
            },
            dialogHide:function(index){
                this.dialog[index].url='';
                this.dialog[index].title = '';
                this.dialog[index].visible = false;
            },
            selected:function(key) {
                $('#tab-0').attr({'tabindex':'-1','aria-selected':false});
                $('#pane-0').css('display','none');
                let sel = this.menu[key];
                this.openMenu(sel);
            },
            removeTab:function(targetName){
                let activeName = this.activityTab;
                let tabs = this.editableTabs;
                if (activeName === targetName) {
                    tabs.forEach((tab, index) => {
                        if (tab.id === targetName) {
                        let nextTab = tabs[index - 1] || tabs[index + 1];
                        if (nextTab) {
                            activeName = nextTab.id;
                        }
                    }
                });
                }
                this.activityTab = activeName;
                this.editableTabs = tabs.filter(tab => tab.id !== targetName);
                //解决  后台-菜单栏都显示选中状态（打开菜单关闭后再打开） 问题
                if(tabs.length == 1){
                    $('#tab-0').attr({'tabindex':'-1','aria-selected':true});
                    $('#pane-0').css('display','block');
                    this.isActive = true;
                }
            },
            openMenu:function({id,code,pic,title,url}){
                let menuIndex = this.editableTabs.findIndex(o => o.id==code);
                if(menuIndex==-1){
                    this.editableTabs.push({
                        pic:pic,
                        title: title,
                        id: code,
                        url: url+'/'+code+'?token=${token}'
                    });
                    this.activityTab = code;
                }
                else{
                    this.activityTab = code;
                }
            },
            closeDialog:function(ind){
                this.dialog[ind].url='';
                this.dialog[ind].title = '';
            },
            dialogUrl:function(ind){
                //console.log(111);
                let u = this.dialog[ind].url;
                if(u == '' || u == null){
                    return null;
                }
                return u+(u.indexOf("?")>-1?"&":"?")+"token=${token}";
            },
            updatePwd:function () {
                this.dialog[1].url='${base}/user/editPwdEntrance/.1.1';
                this.dialog[1].title = '修改密码';
                this.dialog[1].visible = true;
                this.dialog[1].height = 280;
                this.dialog[1].width = 400;
                $(".dialogCustom"+1).css("width","420px");
            },
            logout:function () {
                //location.href = "${base}/logout/"+localStorage.getItem("token");
                closeWebSocket();
                location.href = "${base}/view/logout?token=" + localStorage.getItem("token");
            },
            getNum:function () {
               axios.get('${base}/enterprisewhistle/getUnprocessedDemandNum',
                    {headers: {
                            "Content-Type": "application/json",
                            "X-AUTH-TOKEN": localStorage.getItem("token")
                        }})
                    .then(function (res) {
                        if (res.data.code === 0) {
                            var body = res.data.body;
                            vue.$data.checkNum = body.checkNum;
                            vue.$data.dealNum = body.dealNum;
                            vue.$data.transferNum = body.transferNum;
                            vue.$data.userType = body.userType;
                        } else {

                        }
                    }).catch(function (err) {
                    v.$message({type: 'error', message: '网络错误，请稍后重试'});
                });
            },
            openTag:function (i) {
                var menuStr = {};
                if(i === 1){
                    //打开哨声管理 标签页
                    menuStr.id = '419';
                    menuStr.code = '.6.1';
                    menuStr.pic = '';
                    menuStr.title = '哨声管理';
                    menuStr.url = '/rbac/enterprisewhistle/view/moduleEntrance';
                } else if(i === 2){
                    //打开部门报道 标签页
                    menuStr.id = '443';
                    menuStr.code = '.6.3';
                    menuStr.pic = '';
                    menuStr.title = '响应部门哨声管理';
                    menuStr.url = '/rbac/enterprisewhistle/view/respDealEntrance';
                } else if(i === 3){
                    //打开综合受理中心哨声管理 标签页
                    menuStr.id = '457';
                    menuStr.code = '.6.7';
                    menuStr.pic = '';
                    menuStr.title = '综合处理中心哨声管理';
                    menuStr.url = '/rbac/enterprisewhistle/view/acceptCenterEntrance';
                }
                $('#pane-0').css('display','none');
                this.openMenu(menuStr);
            },
            showMenu: function () {
                $("#menuDivId").removeAttr("style");
                $("#headPicDivId").removeAttr("style");
                $("#headPicDivId").attr("style","text-align:center;padding-top: 30px");
                $("#nameDivId").removeAttr("style");
                $("#nameDivId").attr("style","text-align: center;color: #fff");
            }
        },
        mounted: function () {
            setTimeout(this.showMenu, 500);
            this.getNum();
            //判断当前用户权限中是否包含 哨声管理 及 部门报道的功能权限，来决定是否显示待审核数量 待处理数量
            var menu = this.$data.menu;
            /*var menuStr = JSON.stringify(this.$data.menu);//JSON.parse(this.$data.menu);
            console.log(menu);
            var menu = JSON.parse(menuStr);*/
            if(menu['.6.1'] != null && menu['.6.1'] != '' && menu['.6.1'] != 'undefined'){
                this.$data.isShowCheck = 1;
            } else {
                this.$data.isShowCheck = 0;
            }
            if(menu['.6.3'] != null && menu['.6.3'] != '' && menu['.6.3'] != 'undefined'){
                this.$data.isShowDeal = 1;
            } else {
                this.$data.isShowDeal = 0;
            }
            if(menu['.6.7'] != null && menu['.6.7'] != '' && menu['.6.7'] != 'undefined'){
                this.$data.isShowTransfer = 1;
            } else {
                this.$data.isShowTransfer = 0;
            }
        }
    });


    var userID = localStorage.getItem('id');
    var userType = localStorage.getItem('userType');
    var websocket=null;
    var lockReconnect = false;//避免重复连接
    var tt;
    $(function() {
        if(userType != 1){
            try {
                //创建WebSocket
                connectWebSocket();
            } catch(e) {
                console.log('catch');
                reconnect();
            }
        }
    })

    //强制关闭浏览器  调用websocket.close（）,进行正常关闭
    window.onunload = function() {
        //关闭连接
        closeWebSocket();
    }

    //建立WebSocket连接
    function connectWebSocket(){
        console.log("开始...");
        //建立webSocket连接
        websocket = new WebSocket("wss://esptest.jingcaiwang.cn/myHandler/ID="+userID+"?token="+localStorage.getItem('token'));
        //websocket = new WebSocket("ws://localhost:10010/myHandler/ID="+userID+"?token="+localStorage.getItem('token'));

        //打开webSokcet连接时，回调该函数
        websocket.onopen = function () {
            console.log("onpen");
            //send();
            //心跳检测重置
            heartCheck.start();
        }

        //关闭webSocket连接时，回调该函数
        websocket.onclose = function () {
            //关闭连接
            console.log("onclose");
            reconnect();
        }

        websocket.onerror = function() {
            console.log('onerror');
            reconnect();
        };

        //接收信息
        websocket.onmessage = function (msg) {
            console.log(msg.data);
            var data = msg.data;
            if(data != 'Successfully created Socket connection' && data != 'pang'){
                var obj = JSON.parse(msg.data);
                vue.$data.checkNum = obj.checkNum;
                vue.$data.dealNum = obj.dealNum;
                vue.$data.transferNum = obj.transferNum;
                vue.$data.userType = obj.userType;
            }
            //心跳检测重置
            heartCheck.start();
        }
    }

    //发送消息
    function send(){
        var postValue = {};
        postValue.id = userID;
        websocket.send(JSON.stringify(postValue));
    }
    
    function heartbeat() {
        var postValue = {};
        postValue.id = userID;
        postValue.message = "ping";
        websocket.send(JSON.stringify(postValue));
    }
    
    //关闭连接
    function closeWebSocket(){
        if(websocket != null) {
            websocket.close();
        }
    }

    //心跳检测
    var heartCheck = {
        timeout: 540000,
        timeoutObj: null,
        serverTimeoutObj: null,
        start: function(){
            var self = this;
            this.timeoutObj && clearTimeout(this.timeoutObj);
            this.serverTimeoutObj && clearTimeout(this.serverTimeoutObj);
            this.timeoutObj = setTimeout(function(){
                //这里发送一个心跳，后端收到后，返回一个心跳消息，
                //onmessage拿到返回的心跳就说明连接正常
                heartbeat();
                self.serverTimeoutObj = setTimeout(function() {
                    closeWebSocket();
                }, self.timeout);
            }, this.timeout)
        }
    }

    //自动重连
    function reconnect() {
        if(lockReconnect) {
            return;
        };
        lockReconnect = true;
        //没连接上会一直重连，设置延迟避免请求过多
        tt && clearTimeout(tt);
        tt = setTimeout(function () {
            connectWebSocket();
            lockReconnect = false;
        }, 40000);
    }
</script>