
<#include "/comm/head.html">
<body>
<style>
    .el-header .el-input__inner{ width:140px; }
    .el-date-editor { width:140px !important; }
    .el-header{ padding: 0 5px }
    .el-main {
        padding: 0px;
        margin: 0px;
        overflow:visible !important;
    }
    .el-transfer-panel {
        border: 1px solid #ebeef5;
        border-radius: 4px;
        overflow: hidden;
        background: #fff;
        display: inline-block;
        vertical-align: middle;
        width: 250px!important;
        max-height: 100%;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        position: relative;
    }
</style>
<div id="app">

    <div class="demo-form-inline" style="padding: 5px 20px 0px 0px;width: 100%;">


        <el-form status-icon :model="formData" :rules="rules" ref="formData" label-width="100px" style="width: 100%;">
            <el-row>
                <el-col>
                    <el-transfer
                            filterable
                            :props="{key: 'id', label: 'name'}"
                            :titles="['未拥有的数据权限列表', '已拥有的数据权限列表']"
                            @change="handleChange"
                            v-model="formData.moduleIds"
                            :data="dataList"></el-transfer>
                </el-col>

               <el-col>
                   <el-form-item style="margin-top: 40px;">
                       <el-button type="primary" icon="el-icon-check" @click="saveUserDataPermission()">分配</el-button>
                       <el-button type="info" icon="el-icon-close" @click="close()">关闭</el-button>
                   </el-form-item>
               </el-col>
            </el-row>

        </el-form>
    </div>
</div>

<#include "/comm/js.html">

<script type="text/javascript">
    let userId = ${userId};
    let dataList = ${dataList};
    let userDataList = ${userDataList};
    let selectDataList = [];
    var vue = loadForm(
        {
            methods: {
                handleChange: function (value, direction, movedKeys) {
                    //console.log(movedKeys);
                    for (var i in movedKeys){
                        this.formData.selectDataList.push(movedKeys[i]);
                    }
                },
                saveUserDataPermission :function () {
                    //console.log(this.formData.userDataList);
                    axios.post('${base}/user/userDataPermissionLink',
                        this.formData,
                        {headers: {
                                "Content-Type": "application/json",
                                "X-AUTH-TOKEN": localStorage.getItem("token")
                            }})
                        .then(function (res) {
                            if (res.data.code === 0) {
                                v.$message({type: 'success', message: res.data.message});
                                v.dialogHide(1);
                                window.parent.frames["${iframe}"].contentWindow.vue.reload();
                            } else {
                                v.$message({type: 'error', message: res.data.message});
                            }
                        }).catch(function (err) {
                        v.$message({type: 'error', message: '网络错误，请稍后重试'});
                    });
                },
                close: function () {
                    v.dialogHide(1);
                }
            },
            mounted: function () {

            },
            formData: {
                id: userId
                , dataList : dataList
                , moduleIds: userDataList
                , selectDataList : selectDataList
                ,relationType: 0
            },
            rules: {

            },
            data: {
                dataList: dataList
                , userDataList: userDataList
            },
            urlSave: '${base}/userapproval/save',
            dialogIndex: 0,
            iframe: '${iframe}'
        }
    );
</script>
</body>
</html>