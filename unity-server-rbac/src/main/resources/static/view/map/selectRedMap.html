<#include "/comm/head.html">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<body>
<style>
    #_top {
        min-width: 100%;
        margin-bottom: 10px;
    }

    html, body #allmap {
        width: 1140px;
        height: 92%;
        overflow: hidden;
        margin: 0;
        font-family: "微软雅黑";
    }

    dl, dt, dd, ul, li {
        margin: 0;
        padding: 0;
        list-style: none;
    }

    p {
        font-size: 12px;
    }

    dt {
        font-size: 14px;
        font-family: "微软雅黑";
        font-weight: bold;
        border-bottom: 1px dotted #000;
        padding: 5px 0 5px 5px;
        margin: 5px 0;
    }

    dd {
        padding: 5px 0 0 5px;
    }

    li {
        line-height: 28px;
    }

    form {
        position: relative;
        width: 345px;
    }

    input, button {
        border: none;
        outline: none;
    }

    input {
        width: 100%;
        height: 30px;
        padding-left: 13px;
    }

    button {
        height: 35px;
        width: 30px;
        cursor: pointer;
        position: absolute;
    }

    .bar6 input {
        border: 2px solid #409EFF;
        border-radius: 5px;
        background: transparent;
        top: 0;
        right: 0;
    }

    .bar6 button {
        background: #409EFF;
        border-radius: 0 5px 5px 0;
        width: 60px;
        top: 0;
        right: -15px;
    }

    .anchorBL {
        display: none;
    }

    .BMapLib_rectangle, .BMapLib_last {
        display: none;
    }

    .BMapLib_polygon {
        display: block;
    }

    .BMapLib_polyline {
        display: none;
    }

    .BMapLib_circle {
        display: none;
    }
</style>
<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=mZBNMG8UlCdyFAXnu2GaDffBGmv7UE74"></script>
<!--加载鼠标绘制工具-->
<script type="text/javascript"
        src="https://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
<link rel="stylesheet" href="https://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css"/>
<!--加载检索信息窗口-->
<script type="text/javascript"
        src="https://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.js"></script>
<link rel="stylesheet" href="https://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.css"/>
<script type="text/javascript"
        src="http://api.map.baidu.com/library/AreaRestriction/1.2/src/AreaRestriction_min.js"></script>
<div id="_map">
    <div id="_top">
        <div class="search bar6">
            <form>
                <input type="text" id="addrName" placeholder="请输地点名称" name="cname">
                <button type="button" onclick="_search()" style="font-size:13px;color:#F9F0DA;">搜索</button>
                <button type="button" onclick="_submit()"
                        style="width: 330px;height:39px;left: 426px;top: 0px;border-radius:5px 5px 5px 5px;background:#409EFF;color: white"
                        class="el-button"
                        aria-describedby="el-tooltip-5350" tabindex="0"><i class="el-icon-location"></i> 确认
                </button>
                <button type="button" onclick="clearAll()"
                        style="width: 330px;height:39px;left: 800px;top: 0px;border-radius:5px 5px 5px 5px;background:#409EFF;color: white"
                        class="el-button"
                        aria-describedby="el-tooltip-5350" tabindex="0"><i class="el-icon-location"></i> 清除
                </button>
            </form>
        </div>
    </div>
    <div id="allmap" style="overflow:hidden;zoom:1;position:relative;">
        <div id="map" style="height:100%;-webkit-transition: all 0.5s ease-in-out;transition: all 0.5s ease-in-out;">
        </div>
    </div>

</div>

<#include "/comm/js.html">
<script type="text/javascript" charset="utf-8" src="${cms}/lib/cropper/jquery.js"></script>
<script type="text/javascript">
    let lng = ${lng};
    let lat = ${lat};
    let redWhistleMapList = ${redWhistleMapList};
    let _oldlng = ${lng};
    let _oldlat = ${lat};
    var overlays = [];
    var overlaysMarker = [];
    var overlayArray = [];
    var styleOptions = {
        strokeColor: "#C3151D",    //边线颜色。
        fillColor: "#C3151D",      //填充颜色。当参数为空时，圆形将没有填充效果。
        strokeWeight: 1.5,       //边线的宽度，以像素为单位。
        strokeOpacity: 1,	   //边线透明度，取值范围0 - 1。
        fillOpacity: 0.1,      //填充的透明度，取值范围0 - 1。
        strokeStyle: 'solid' //边线的样式，solid或dashed。
    };
    // 百度地图API功能
    var map = new BMap.Map("map");    // 创建Map实例
    var point = new BMap.Point(lng, lat);
    map.centerAndZoom(point, 14);  // 初始化地图,设置中心点坐标和地图级别
    var marker = new BMap.Marker(point);  // 创建标注
    map.addOverlay(marker);// 将标注添加到地图中
    addPolygonList(map);

    function addPolygonList(map) {
        console.log("--redWhistleMapList--"+JSON.stringify(redWhistleMapList));
        var pointList = [];
        for (var p = 0; p < redWhistleMapList.length; p++) {
            var pointMap = new BMap.Point(redWhistleMapList[p].lng, redWhistleMapList[p].lat);
            pointList.push(pointMap);
            overlayArray.push(pointMap);
        }
        if (overlayArray.length > 0) {
            map.addOverlay(new BMap.Polygon(pointList, styleOptions));

        }
    }
    var local = new BMap.LocalSearch(map, {
        renderOptions: {map: map}
    });

    //添加地图类型控件
    map.addControl(new BMap.MapTypeControl({
        mapTypes: [
            BMAP_NORMAL_MAP,
            BMAP_HYBRID_MAP
        ],
        anchor: BMAP_ANCHOR_BOTTOM_RIGHT, //位置
        offset: new BMap.Size(10, 10)

    }));
    map.setCurrentCity("北京");          // 设置地图显示的城市 此项是必须设置的
    map.enableScrollWheelZoom(true);
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT, offset: new BMap.Size(70, 20)});// 左上角，添加比例尺
    var top_left_navigation = new BMap.NavigationControl({anchor: BMAP_ANCHOR_TOP_LEFT, offset: new BMap.Size(10, 20)});  //左上角，添加默认缩放平移控件
    map.addControl(top_left_control);
    map.addControl(top_left_navigation);


    //实例化鼠标绘制工具
    var drawingManager = new BMapLib.DrawingManager(map, {
        isOpen: false, //是否开启绘制模式
        enableDrawingTool: true, //是否显示工具栏
        drawingToolOptions: {
            anchor: BMAP_ANCHOR_TOP_RIGHT, //位置
            offset: new BMap.Size(10, 5) //偏离值

        },
        polygonOptions: styleOptions //多边形的样式
    });

    var overlaycomplete = function (e) {
        if (e.drawingMode == 'marker') {
            lng = e.overlay.point.lng;
            lat = e.overlay.point.lat;
            clearAllMarkers();
            _oldlng = lng;
            _oldlat = lat;
            map.panTo(e.overlay.point);
            overlaysMarker.push(e.overlay);

        } else if (e.drawingMode == 'polygon') {
            overlays.push(e.overlay);
            var path = e.overlay.getPath();//Array<Point> 返回多边型的点数组
            for (var i = 0; i < path.length; i++) {
                console.log("lng:" + path[i].lng + " lat:" + path[i].lat);
                var mapCoordinate = {lng: '', lat: ''};
                mapCoordinate.lng = path[i].lng;
                mapCoordinate.lat = path[i].lat;
                overlayArray.push(mapCoordinate);
            }
        }

    };

    //添加鼠标绘制工具监听事件，用于获取绘制结果
    drawingManager.addEventListener('overlaycomplete', overlaycomplete);


    // 添加定位控件
    var geolocationControl = new BMap.GeolocationControl({
        anchor: BMAP_ANCHOR_BOTTOM_RIGHT,
        offset: new BMap.Size(1090, 410)
    });
    geolocationControl.location();//这里是执行定位事件
    geolocationControl.addEventListener("locationSuccess", function (e) {
        // 定位成功事件后我们可以获取当前的经纬度这个方法的经纬度已经很精准了
        console.log("===========");
        /*map.clearOverlays();
        var _marker = new BMap.Marker(new BMap.Point(_lng, _lat));  // 创建标注
        map.addOverlay(_marker);// 将标注添加到地图中*/
        map.panTo(new BMap.Point(lng, lat));
        // addPolygonList(map);
        // var __markerList = new BMap.Marker(new BMap.Point(_redWhistleMapList));  // 创建标注
        //drawingManager.close();//关闭绘图

    });
    geolocationControl.addEventListener("locationError", function (e) {
        // 定位失败事件 这里的失败起初以为是不允许浏览器定位也会触发，然而这是不对的
        v.$message.error("定位失败，请稍后再试...");
    });
    map.addControl(geolocationControl);

    function _submit() {
        if (overlayArray.length === 0) {
            v.$message.error("请选择服务港区域");
            return false;
        }
        /*if(overlays.length != 3){
            v.$message.error("请选择一个坐标点位和一个服务港区域");
            return false;
        }*/
        redWhistleMapList = overlayArray;
        window.parent.frames["${iframe}"].contentWindow.vue.${method}(lng, lat , redWhistleMapList);
    }

    function _search() {
        local.search($('#addrName').val());
    }

    //清除选定的区域范围
    // function removeOldPoint() {
    //     console.log("==removeOldPoint==" + overlayArray);
    //     map.removeOverlay(new BMap.Point(_oldlng, _oldlat));
    // }

    //清除标记点
    function clearAllMarkers() {
        for(var i = 0; i < overlaysMarker.length; i++){
            map.removeOverlay(overlaysMarker[i]);
        }
        overlaysMarker.length = 0
    }
    //清除地图上的所有标记
    function clearAll() {
        console.log("==clearAll==" + overlayArray);
        map.clearOverlays();
        overlays.length = 0;
        overlaysMarker.length = 0;
        overlayArray.length = 0;
        redWhistleMapList=[];
        drawingManager.close();//关闭绘图
    }
</script>

</body>

